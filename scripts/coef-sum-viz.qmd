---
title: "coef-sum-viz"
author: "Henry Li"
format: html
editor: visual
---

## Visualization

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
```

```{r}
# Define the folder path containing the CSV files
folder_path <- here("output")

# Get a list of all CSV files in the folder
csv_files <- list.files(path = folder_path, pattern = "*.csv", full.names = TRUE)

# Read and combine all CSV files, ensuring Team_ID is always a character
combined_data <- csv_files %>%
  lapply(function(file) {
    df <- read.csv(file)
    df$Team_ID <- as.character(df$Team_ID)  # Ensure Team_ID is a character
    return(df)
  }) %>%
  bind_rows(.id = "file_id") %>%
  filter(!is.na(Team_ID))
```

```{r}
# Count how many times each coefficient is significant and not significant across rounds
significance_summary <- combined_data %>%
  group_by(Covariate, Team_ID, Vero_type) %>%
  summarize(
    Significant_Count = sum(Significant_at_0.001),
    Not_Significant_Count = n() - Significant_Count,
    Mean_Estimate_If_Significant = mean(Estimate[Significant_at_0.001 == TRUE], na.rm = TRUE)
  ) %>%
  ungroup()
```

## mean viz - box plot

```{r}
ggplot(significance_summary, aes(x = Covariate, y = Mean_Estimate_If_Significant)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Mean Estimate (If Significant) for Each Covariate",
    x = "Covariate",
    y = "Mean Estimate (If Significant)"
  ) +
  theme_minimal()
```
##
```{r}
ggplot(significance_summary, aes(x = Covariate, y = Mean_Estimate_If_Significant)) +
  geom_violin(trim = FALSE) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5, color = "blue") +
  labs(
    title = "Distribution of Mean Estimate (If Significant) for Each Covariate",
    x = "Covariate",
    y = "Mean Estimate (If Significant)"
  ) +
  theme_minimal()
```

## violin plot
```{r}
ggplot(significance_summary, aes(x = Covariate, y = Mean_Estimate_If_Significant)) +
  geom_violin(trim = FALSE, fill = "lightgray") +
  geom_boxplot(width = 0.1, color = "red", alpha = 0.7) +
  labs(
    title = "Distribution of Mean Estimate (If Significant) for Each Covariate",
    x = "Covariate",
    y = "Mean Estimate (If Significant)"
  ) +
  theme_minimal()

```

## mean visualization - density plot

```{r}
# ggplot(significance_summary, aes(x = Mean_Estimate_If_Significant, fill = Covariate)) +
#   geom_density(alpha = 0.5) +
#   labs(
#     title = "Density Plot of Mean Estimate (If Significant) for Each Covariate",
#     x = "Mean Estimate (If Significant)",
#     y = "Density"
#   ) +
#   theme_minimal()
```

## Summarize across teams to get overall significance counts per coefficient

```{r}
overall_significance <- significance_summary %>%
  group_by(Covariate) %>%
  summarize(
    Total_Significant = sum(Significant_Count),
    Total_Not_Significant = sum(Not_Significant_Count), 
    Percent_Significant = Total_Significant / (Total_Significant + Total_Not_Significant),
    Mean_Estimate_If_Significant = mean(Mean_Estimate_If_Significant, na.rm = TRUE)
  )
```

## Sig of Coef acorss rounds

```{r}
ggplot(overall_significance, aes(x = Covariate)) +
  geom_bar(aes(y = Total_Significant), stat = "identity", fill = "blue", alpha = 0.7) +
  geom_text(aes(y = Total_Significant, label = Total_Significant), 
            position = position_dodge(width = 0.9), vjust = -0.5, color = "black") +
  geom_bar(aes(y = -Total_Not_Significant), stat = "identity", fill = "red", alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Significance of Coefficients Across Rounds",
    x = "Coefficient",
    y = "Number of Rounds (Overall)",
    fill = "Significance"
  ) +
  theme_minimal()
```

## Mean estimate viz

```{r}
ggplot(overall_significance, aes(x = Covariate)) +
  geom_bar(aes(y = Mean_Estimate_If_Significant), stat = "identity", fill = "blue", alpha = 0.7) +
  labs(
    title = "Mean of Covariates Overall (if Significant)",
    x = "Coefficient",
    y = "Estimate (in log odds ratio)", 
    fill = "Significance"
  ) +
  theme_minimal()
```

## Across Verotypes and Coefficients

```{r}
overall_significance_by_type <- significance_summary %>%
  group_by(Covariate, Vero_type) %>%
  summarize(
    Total_Significant = sum(Significant_Count),
    Total_Not_Significant = sum(Not_Significant_Count), 
    Percent_Significant = Total_Significant / (Total_Significant + Total_Not_Significant),
    Mean_Estimate_If_Significant = mean(Mean_Estimate_If_Significant, na.rm = TRUE)
  )
```

## Visualization

```{r}
ggplot(overall_significance_by_type, aes(x = Covariate, y = Percent_Significant, fill = Vero_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Percent_Significant, 3)*100), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(
    title = "Significance Percentage of Covariates by Vero_type",
    x = "Covariate",
    y = "Percent_Significant",
    fill = "Vero_type"
  ) +
  theme_minimal()
```

```{r}
ggplot(overall_significance_by_type, aes(x = Covariate, y = Mean_Estimate_If_Significant, fill = Vero_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Mean_Estimate_If_Significant,2)), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(
    title = "Mean of Covariates by Vero_type",
    x = "Covariate",
    y = "Estimate",
    fill = "Vero_type"
  ) +
  theme_minimal()
```

# Save the plot to a file

```{r}
ggsave("coefficient_significance_summary.png", width = 10, height = 6)
ggsave("significance_percentage_by_vero_type.png", width = 10, height = 6)
```
